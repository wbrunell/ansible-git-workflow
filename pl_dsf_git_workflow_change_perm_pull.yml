#
# What : Playbook to clean and prepare the repo for the Poc of the Git Workflow
#	 This includes :	- remove all files
#				- remove all tags
#				- remove all branches
#				- create new empty files t1 t2 t3 t4
#
# Date : 17.May 2018 Walter Brunelli
#
# Usage: ansible-playbook pl_dsf_git_workflow_clean_repo.yml
#	 ansible-playbook pl_dsf_git_workflow_clean_repo.yml --extra-vars "repo_url=https://github.com/wbrunell/repo01"
#	 ansible-playbook pl_dsf_git_workflow_clean_repo.yml --extra-vars "repo_dir_name=repo01"
#	 ansible-playbook pl_dsf_git_workflow_clean_repo.yml --extra-vars "local_base_dir=/var/tmp"

---
- name: Clean the repo-directory
  hosts: localhost
  become_user: none
  become: no
  vars_files:
    - pl_dsf_git_workflow_setupvariables.yml

#  vars:
#    var_repo_url: "{{ repo_url | default('https://github.com/wbrunell/repo01') }}"
#    var_local_base_dir: "{{ local_base_dir | default('/var/tmp') }}"
#    var_repo_dir_name: "{{ repo_dir_name | default('repo01') }}"

  tasks:
    - name: Check if Directory exists
      stat: path={{local_base_dir}}/{{repo_dir_name}}/.git
      register: dir
    - name: Exit if directory doesn not exists
      fail: msg="Local directory {{local_base_dir}}/{{repo_dir_name}} does not exist. Exiting."  
      when: dir.stat.exists == false
    - name: Sync the directory (if it exists) and delete local Working-Dir staff which does not exist
      shell: 'cd {{local_base_dir}}/{{repo_dir_name}}; /usr/local/bin/git pull; /usr/local/bin/git clean -f'
      when: dir.stat.exists == true
      #debug: msg="repo_dirname = {{repo_dir_name}}"
      
#    - name: Find latest version (tag)
#      shell: git describe --abbrev=0 --tags chdir=/tmp/{{stream_feed}}
#      register: latest_tag  
#    - name: Create tar.gz Archive for RPM package (excluding .git directory)
#      shell: /usr/bin/tar czf /tmp/{{stream_feed}}.tar.gz ./{{stream_feed}} --exclude ./{{stream_feed}}/.git chdir=/tmp warn=false
#    - name: Cleanup the old rpmbuild structure
#      file: path=~/rpmbuild state=absent
#    - name: Create the rpmbuild structure
#      file: path=~/{{ item }} state=directory
#      with_items:
#        - rpmbuild/SPECS
#        - rpmbuild/SOURCES
#        - rpmbuild/BUILD
#        - rpmbuild/RPMS
#    - name: Copy the tar.gz archive to the rpmbuild structure
#      command: cp /tmp/{{stream_feed}}.tar.gz ~/rpmbuild/SOURCES
#    - name: Copy the spec-file template
#      template: src=templates/rpm_spec_mit_version.spec dest=~/rpmbuild/SPECS 
#    - name: Build the RPM package. The finished package will be ~rpmbuild/rpmbuild/RPMS/noarch/{{stream_feed}}-{{latest_tag.stdout[1:]}}-0.noarch.rpm
#      command: rpmbuild -vv -bb ~/rpmbuild/SPECS/rpm_spec_mit_version.spec --clean
#    - name: Copy RPM package to the TML repository
#      shell: scp /home/dsfrpmbuild/rpmbuild/RPMS/noarch/{{stream_feed}}-{{latest_tag.stdout[1:]}}-0.noarch.rpm cos020:/var/www/html/dsf_tml

#- name: Update TML Repo
#  hosts: cos020
#  become_user: dsfrpmbuild
#  become: yes
#  tasks:
#    - name: Update repo
#      shell: "createrepo /var/www/html/dsf_tml --update"
#
#- name: Install on DEV server
#  hosts: dsf_dev
#  become_user: root
#  become: yes
#  vars:
#    stream_feed: "{{ repo_name | default('dsf-pseudo-xxx') }}"
#  tasks:
#    - name: Make yum cache expire in order to re-read updated reposerver metadata
#      shell: yum clean expire-cache warn=no
#    - name: Update repo metadata
#      shell: yum repolist warn=no
#    - name: Install package
#      #yum: name={{stream_feed}}-{{hostvars.cos019.latest_tag.stdout[1:]}}-0.noarch state=present
#      yum: name={{stream_feed}} state=latest


